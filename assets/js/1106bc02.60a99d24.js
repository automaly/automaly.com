"use strict";(self.webpackChunknuxulutest=self.webpackChunknuxulutest||[]).push([[4112],{10596:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var a=t(74848),i=t(28453);const s={title:"How to block vendor and send email for notification.",description:"Using batch to find and block vendor base on last transaction condition and notify for them by emails.",date:new Date("2017-01-10T00:00:00.000Z"),categories:["AX2012"],tags:["xpp","send email"]},r=void 0,o={id:"development/xpp-sample/2017-01-10-Block-vendor-and-send-email-for-notification-in-Dynamics-AX/index",title:"How to block vendor and send email for notification.",description:"Using batch to find and block vendor base on last transaction condition and notify for them by emails.",source:"@site/docs/03-development/01-xpp-sample/2017-01-10-Block-vendor-and-send-email-for-notification-in-Dynamics-AX/index.md",sourceDirName:"03-development/01-xpp-sample/2017-01-10-Block-vendor-and-send-email-for-notification-in-Dynamics-AX",slug:"/development/xpp-sample/2017-01-10-Block-vendor-and-send-email-for-notification-in-Dynamics-AX/",permalink:"/docs/development/xpp-sample/2017-01-10-Block-vendor-and-send-email-for-notification-in-Dynamics-AX/",draft:!1,unlisted:!1,tags:[{inline:!0,label:"xpp",permalink:"/docs/tags/xpp"},{inline:!0,label:"send email",permalink:"/docs/tags/send-email"}],version:"current",lastUpdatedBy:"Luan Nguyen",lastUpdatedAt:1701636614e3,frontMatter:{title:"How to block vendor and send email for notification.",description:"Using batch to find and block vendor base on last transaction condition and notify for them by emails.",date:"2017-01-10T00:00:00.000Z",categories:["AX2012"],tags:["xpp","send email"]},sidebar:"tutorialSidebar",previous:{title:"Using Methods in Table Filters & Query Ranges in Dynamics AX 2012",permalink:"/docs/development/xpp-sample/2017-01-02-using-methods-in-table-filters-query-ranges-in-dynamics-ax-2012/"},next:{title:"Overview delete action in Dyanmics AX 2012",permalink:"/docs/development/xpp-sample/2017-01-19-Overview-delete-action-in-Dyanmics-AX-2012/"}},l={},c=[{value:"1. Set up E-mail parameters",id:"1-set-up-e-mail-parameters",level:3},{value:"2. Vendor emails",id:"2-vendor-emails",level:3},{value:"3. Batch class",id:"3-batch-class",level:3}];function d(e){const n={code:"code",em:"em",h3:"h3",img:"img",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"Main requirements is Using batch to find and block vendor base on last transaction condition and notify for them by emails."}),"\n",(0,a.jsx)(n.h3,{id:"1-set-up-e-mail-parameters",children:"1. Set up E-mail parameters"}),"\n",(0,a.jsxs)(n.p,{children:["For set up email, we need Go to AX ",(0,a.jsx)(n.code,{children:"System administrator > Setup > E-mail parameters"})]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Email-parameters",src:t(8078).A+"",width:"587",height:"356"})}),"\n",(0,a.jsx)(n.h3,{id:"2-vendor-emails",children:"2. Vendor emails"}),"\n",(0,a.jsxs)(n.p,{children:["Vendor emails locate on ",(0,a.jsx)(n.code,{children:"LogisticsElectronicAddress.Locator"}),", ",(0,a.jsx)(n.code,{children:"partyTable.PrimaryContactEmail"}),", ",(0,a.jsx)(n.code,{children:"partyLocation.Location"}),", please take a look on this job to find how to update Vendor emails and you also could see the relations more clearly."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-C#",children:'static void UpdateVendorEmail(Args _args)\n{\n    VendTable                   vendTable;\n    LogisticsElectronicAddress  electronicAddress;\n    DirPartyTable               partyTable;\n    DirPartyLocation            partyLocation;\n\n    electronicAddress.initValue();\n    electronicAddress.Type = LogisticsElectronicAddressMethodType::Email;\n    electronicAddress.Description = "max";\n    electronicAddress.Locator     = "luan52@outlook.com";\n    electronicAddress.IsPrimary   = NoYes::Yes;\n    electronicAddress.insert();\n\n    while select forUpdate partyTable\n        exists join vendTable\n            where vendTable.Party == partyTable.RecId\n    {\n        ttsBegin;\n        partyTable.PrimaryContactEmail = electronicAddress.RecId;\n        partyTable.update();\n        ttsCommit;\n\n        select firstOnly forupdate partyLocation\n            where partyLocation.Party == partyTable.RecId;\n\n        if (partyLocation)\n        {\n            ttsBegin;\n            partyLocation.Location = electronicAddress.Location;\n            partyLocation.update();\n            ttsCommit;\n        }\n        else\n        {\n            partyLocation.initValue();\n            partyLocation.Location = electronicAddress.Location;\n            partyLocation.Party     = partyTable.RecId;\n            partyLocation.insert();\n        }\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"3-batch-class",children:"3. Batch class"}),"\n",(0,a.jsxs)(n.p,{children:["Main logic here is find Vend accounts are not exist in ",(0,a.jsx)(n.code,{children:"VendTrans"})," table with condition ",(0,a.jsx)(n.code,{children:"endTrans.TransDate >= beginDate"}),", and ",(0,a.jsx)(n.code,{children:"beginDate"})," count from today ",(0,a.jsx)(n.code,{children:"systemDateGet()"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-C#",children:"public class Max_VendorBlockedBatch extends RunBaseBatch\n{\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Get the date before 6 months from today"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-C#",children:"public TransDate getBeginDate()\n{\n    TransDate   beginDate;\n    TransDate   currentDate;\n    Months      month;\n    YearBase    years;\n    Day         day;\n\n    currentDate = systemDateGet();\n    day         = dayOfMth(currentDate);\n    month       = mthOfYr(currentDate);\n    years       = year(currentDate);\n    if (month < 6)\n    {\n        beginDate = mkDate(day, 12 - (6 - month) + 1, years - 1);\n    }\n    else\n    {\n        beginDate = mkDate(day, month - 6 + 1, years);\n    }\n\n    return beginDate;\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Send E-mail"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-C#",children:"\npublic void sendEmail(AccountNum _vendor, str _recipient)\n{\n\xa0\xa0\xa0\xa0str\xa0                                    sender  = 'sender@email.com';\n\xa0\xa0\xa0\xa0str\xa0                                    subject = 'Account blocked';\n\xa0\xa0\xa0\xa0str\xa0                                    body    = 'Your account is blocked due to last transaction';\n\xa0\xa0\xa0\xa0List                                    toList;\n\xa0\xa0\xa0\xa0ListEnumerator                          le;\n\xa0\xa0\xa0\xa0Set                                     permissionSet;\n\xa0\xa0\xa0\xa0System.Exception                        e;\n\xa0\xa0\xa0\xa0str                                     mailServer;\n\xa0\xa0\xa0\xa0int                                     mailServerPort;\n\xa0\xa0\xa0\xa0System.Net.Mail.SmtpClient\xa0             mailClient;\n\xa0\xa0\xa0\xa0System.Net.Mail.MailMessage             mailMessage;\n\xa0\xa0\xa0\xa0System.Net.Mail.MailAddress             mailFrom;\n\xa0\xa0\xa0\xa0System.Net.Mail.MailAddress             mailTo;\n\xa0\xa0\xa0\xa0System.Net.Mail.MailAddressCollection   mailToCollection;\n\xa0\n\xa0\xa0\xa0\xa0try\n\xa0\xa0\xa0\xa0{\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0toList = strSplit(_recipient, ';');\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0permissionSet = new Set(Types::Class);\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0permissionSet.add(new InteropPermission(InteropKind::ClrInterop));\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0CodeAccessPermission::assertMultiple(permissionSet);\n\xa0\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailServer      = SysEmaiLParameters::find(false).SMTPRelayServerName;\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailServerPort  = SysEmaiLParameters::find(false).SMTPPortNumber;\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailClient      = new System.Net.Mail.SmtpClient(mailServer, mailServerPort);\n\xa0\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0le = toList.getEnumerator();\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0le.moveNext();\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailFrom    = new System.Net.Mail.MailAddress(sender);\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailTo\xa0     = new System.Net.Mail.MailAddress(strLTrim(strRTrim(le.current())));\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailMessage = new System.Net.Mail.MailMessage(mailFrom, mailTo);\xa0\xa0\xa0\xa0\xa0\n\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailToCollection = mailMessage.get_To();\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0while (le.moveNext())\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0{\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailToCollection.Add(strLTrim(strRTrim(le.current())));\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0}\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailMessage.set_Priority(System.Net.Mail.MailPriority::High);\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailMessage.set_Subject(subject);\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailMessage.set_Body(body);\n\xa0\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailClient.Send(mailMessage);\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0mailMessage.Dispose();\n\xa0\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0CodeAccessPermission::revertAssert();\xa0\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0info(strFmt('Email was sent to vendor %1.', _vendor));\n\xa0\xa0\xa0\xa0}\n\xa0\xa0\xa0\xa0catch (Exception::CLRError)\n\xa0\xa0\xa0\xa0{\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0e = ClrInterop::getLastException();\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0while (e)\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0{\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0info(e.get_Message());\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0e = e.get_InnerException();\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0}\n\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0CodeAccessPermission::revertAssert();\n\xa0\xa0\xa0\xa0}\n}\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Initializes a new instance of the ",(0,a.jsx)(n.em,{children:(0,a.jsx)("c",{children:"Batch"})})," class."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-C#",children:"public static MAX_VendorBlockedBatch construct()\n{\n    return new MAX_VendorBlockedBatch();\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Gets description of the dialog."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-C#",children:"public static ClassDescription description()\n{\n    return 'Vendor blocked batch';\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Find the vendor without transaction and disable, then send email to vendor"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-C#",children:"public void run()\n{\n    VendTrans   vendTrans;\n    VendTable   vendTable;\n    TransDate   beginDate;\n    Email       email;\n    int         i;\n\n    try\n    {\n        beginDate = this.getBeginDate();\n        while select forUpdate AccountNum, Party from vendTable\n            Notexists join vendTrans\n            where vendTrans.AccountNum == vendTable.AccountNum\n                && vendTrans.TransDate >= beginDate\n        {\n            //Set the vendor blocked\n            ttsBegin;\n            vendTable.Blocked = CustVendorBlocked::All;\n            vendTable.update();\n            ttsCommit;\n\n            //Send E-mail to vendor\n            email = vendTable.email();\n            if (email)\n            {\n                this.sendEmail(vendTable.AccountNum, email);\n            }\n            else\n            {\n                warning(strFmt('The vendor %1 did not have E-mail address.', vendTable.AccountNum));\n            }\n        }\n    }\n    catch (Exception::Deadlock)\n    {\n        retry;\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Provides an enter point for the ",(0,a.jsx)("c",{children:"Batch"})," class."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-C#",children:"public static void main(Args _args)\n{\n    MAX_VendorBlockedBatch vendorBlockedBatch = MAX_VendorBlockedBatch::construct();\n\n    if (vendorBlockedBatch.prompt())\n    {\n        vendorBlockedBatch.run();\n    }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"From here you can run class and set up recurrence for batch job."}),"\n",(0,a.jsx)(n.p,{children:"Thank you for reading!"})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8078:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/Email-parameters-7ec9d6e473b03763a495cf2a6181a19d.png"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var a=t(96540);const i={},s=a.createContext(i);function r(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);